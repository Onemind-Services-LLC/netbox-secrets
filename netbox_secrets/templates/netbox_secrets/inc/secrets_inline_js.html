<script type="text/javascript">
(function () {
  'use strict';

  const SESSION_KEY_STORAGE = 'netbox_secrets_sessionid';
  let pendingSessionKeyForm = null;

  function getPrivateKeyModal() {
    const modal = document.getElementById('privkey_modal');
    if (!modal || typeof window.Modal === 'undefined') {
      return null;
    }
    if (typeof window.Modal.getInstance === 'function') {
      return window.Modal.getInstance(modal) || new window.Modal(modal);
    }
    return new window.Modal(modal);
  }

  function getSessionKey() {
    try {
      const key = window.sessionStorage.getItem(SESSION_KEY_STORAGE);
      return key && key.length > 0 ? key : null;
    } catch (err) {
      return null;
    }
  }

  function storeSessionKey(key) {
    if (!key) {
      return;
    }
    try {
      window.sessionStorage.setItem(SESSION_KEY_STORAGE, key);
    } catch (err) {
      // Ignore storage failures (e.g. private browsing).
    }
  }

  function clearSessionKey() {
    try {
      window.sessionStorage.removeItem(SESSION_KEY_STORAGE);
    } catch (err) {
      // Ignore storage failures (e.g. private browsing).
    }
  }

  function setSessionKeyInputs() {
    const key = getSessionKey();
    if (!key) {
      return;
    }
    for (const input of document.querySelectorAll("input[name='session_key']")) {
      input.value = key;
    }
  }

  function hasServerSessionKey() {
    const modal = document.getElementById('privkey_modal');
    if (!(modal instanceof HTMLElement)) {
      return false;
    }
    return modal.dataset.sessionKeyPresent === 'true';
  }

  function hasSessionKey() {
    return Boolean(getSessionKey()) || hasServerSessionKey();
  }

  function withBasePath(path) {
    const pathname = window.location.pathname || '';
    const pluginsIdx = pathname.indexOf('/plugins/');
    const apiIdx = pathname.indexOf('/api/');
    const cutIdx = pluginsIdx >= 0 ? pluginsIdx : apiIdx;
    const base = cutIdx >= 0 ? pathname.slice(0, cutIdx) : '';
    return `${base}${path}`;
  }

  function getCsrfToken() {
    const token = window.CSRF_TOKEN;
    if (typeof token === 'string') {
      return token;
    }
    return '';
  }

  function createToast(level, title, message) {
    const container = document.createElement('div');
    container.setAttribute('class', 'toast-container position-fixed bottom-0 end-0 m-3');

    const main = document.createElement('div');
    main.setAttribute('class', `toast bg-${level}`);
    main.setAttribute('role', 'alert');
    main.setAttribute('aria-live', 'assertive');
    main.setAttribute('aria-atomic', 'true');

    const header = document.createElement('div');
    header.setAttribute('class', `toast-header bg-${level} text-body`);

    const icon = document.createElement('i');
    icon.setAttribute('class', `mdi ${level === 'success' ? 'mdi-check-circle' : 'mdi-alert'}`);

    const titleElement = document.createElement('strong');
    titleElement.setAttribute('class', 'me-auto ms-1');
    titleElement.innerText = title;

    const button = document.createElement('button');
    button.setAttribute('type', 'button');
    button.setAttribute('class', 'btn-close');
    button.setAttribute('data-bs-dismiss', 'toast');
    button.setAttribute('aria-label', 'Close');

    const body = document.createElement('div');
    body.setAttribute('class', 'toast-body');
    body.innerText = message.trim();

    header.appendChild(icon);
    header.appendChild(titleElement);
    header.appendChild(button);

    main.appendChild(header);
    main.appendChild(body);
    container.appendChild(main);
    document.body.appendChild(container);

    return new window.Toast(main);
  }

  function showToast(level, title, message) {
    if (typeof window.Toast === 'undefined') {
      window.alert(`${title}: ${message}`);
      return;
    }
    createToast(level, title, message).show();
  }

  async function apiRequest(url, method, data) {
    const headers = new Headers();
    const csrfToken = getCsrfToken();
    if (csrfToken) {
      headers.set('X-CSRFToken', csrfToken);
    }

    const sessionKey = getSessionKey();
    if (sessionKey) {
      headers.set('X-Session-Key', sessionKey);
    }

    let body;
    if (typeof data !== 'undefined') {
      body = JSON.stringify(data);
      headers.set('content-type', 'application/json');
      headers.set('Accept', 'application/json');
    }

    const res = await fetch(url, { method, body, headers, credentials: 'same-origin' });
    if (res.status === 204) {
      return { ok: true, data: {} };
    }

    const contentType = res.headers.get('Content-Type') || '';
    let payload;
    if (contentType.includes('application/json')) {
      payload = await res.json();
    } else {
      payload = await res.text();
    }

    if (!res.ok) {
      if (Array.isArray(payload)) {
        return { ok: false, error: payload.join('\n') };
      }
      if (payload && typeof payload === 'object') {
        if ('error' in payload) {
          return { ok: false, error: payload.error, exception: payload.exception };
        }
        if ('detail' in payload) {
          return { ok: false, error: payload.detail };
        }
      }
      return { ok: false, error: typeof payload === 'string' ? payload : 'Request failed' };
    }

    return { ok: true, data: payload };
  }

  function apiGet(url) {
    return apiRequest(url, 'GET');
  }

  function apiPost(url, data) {
    return apiRequest(url, 'POST', data);
  }

  function apiDelete(url) {
    return apiRequest(url, 'DELETE');
  }

  function initGenerateKeyPair() {
    const element = document.getElementById('new_keypair_modal');
    const accept = document.getElementById('use_new_pubkey');
    const copyBtn = document.getElementById('copy_prikey');
    const exportBtn = document.getElementById('export_key');
    if (!element || !accept || !copyBtn || !exportBtn) {
      return;
    }

    const publicElem = element.querySelector('textarea#new_pubkey');
    const privateElem = element.querySelector('textarea#new_privkey');

    function handleOpen() {
      for (const elem of [publicElem, privateElem]) {
        if (elem) {
          elem.setAttribute('readonly', '');
        }
      }
      apiGet(withBasePath('/api/plugins/secrets/generate-rsa-key-pair/')).then(res => {
        if (!res.ok) {
          showToast('danger', 'Error', res.error);
          return;
        }
        if (publicElem && privateElem) {
          publicElem.value = res.data.public_key;
          privateElem.value = res.data.private_key;
        }
      });
    }

    function handleAccept() {
      const publicKeyField = document.getElementById('id_public_key');
      if (publicElem && publicKeyField instanceof HTMLTextAreaElement) {
        publicKeyField.value = publicElem.value;
        publicKeyField.innerText = publicElem.value;
      }
    }

    function handleExport() {
      const content = `Public Key\n\n${publicElem ? publicElem.value : ''}\n\nPrivate Key\n\n${privateElem ? privateElem.value : ''}`;
      const blob = new Blob([content], { type: 'text/plain' });
      const anchor = document.createElement('a');
      anchor.style.display = 'none';
      anchor.href = window.URL.createObjectURL(blob);
      anchor.download = 'key.txt';
      document.body.appendChild(anchor);
      anchor.click();
      window.URL.revokeObjectURL(anchor.href);
      document.body.removeChild(anchor);
    }

    element.addEventListener('shown.bs.modal', handleOpen);
    accept.addEventListener('click', handleAccept);
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(privateElem ? privateElem.value : '');
    });
    exportBtn.addEventListener('click', handleExport);
  }

  function toggleSecretButtons(id, action) {
    const unlockButton = document.querySelector(`button.unlock-secret[secret-id='${id}']`);
    const lockButton = document.querySelector(`button.lock-secret[secret-id='${id}']`);
    const copyButton = document.querySelector(`span[secret-id='${id}']`);
    if (unlockButton) {
      unlockButton.classList.toggle('d-none', action === 'unlock');
    }
    if (lockButton) {
      lockButton.classList.toggle('d-none', action === 'lock');
    }
    if (copyButton) {
      copyButton.classList.toggle('d-none', action === 'lock');
    }
  }

  function initLockUnlock() {
    const privateKeyModal = getPrivateKeyModal();

    function unlock(id) {
      if (!id) {
        return;
      }
      const target = document.getElementById(`secret_${id}`);
      apiGet(withBasePath(`/api/plugins/secrets/secrets/${id}/`)).then(res => {
        if (!res.ok) {
          if (res.error && res.error.toLowerCase().includes('invalid session key') && privateKeyModal) {
            privateKeyModal.show();
          } else {
            showToast('danger', 'Error', res.error || 'Failed to unlock secret.');
          }
          return;
        }

        const plaintext = res.data.plaintext;
        if (target && plaintext !== null) {
          if ('value' in target) {
            target.value = plaintext;
          } else {
            target.innerText = plaintext;
          }
          toggleSecretButtons(id, 'unlock');
        } else if (privateKeyModal) {
          privateKeyModal.show();
        }
      });
    }

    function lock(id) {
      if (!id) {
        return;
      }
      const target = document.getElementById(`secret_${id}`);
      if (target) {
        if ('value' in target) {
          target.value = '********';
        } else {
          target.innerText = '********';
        }
      }
      toggleSecretButtons(id, 'lock');
    }

    for (const element of document.querySelectorAll('button.unlock-secret')) {
      element.addEventListener('click', () => unlock(element.getAttribute('secret-id')));
    }
    for (const element of document.querySelectorAll('button.lock-secret')) {
      element.addEventListener('click', () => lock(element.getAttribute('secret-id')));
    }
  }

  function requestSessionKey(privateKey) {
    if (!privateKey || !privateKey.trim()) {
      showToast('warning', 'Missing Private Key', 'Please paste your private RSA key.');
      return;
    }
    apiPost(withBasePath('/api/plugins/secrets/session-key/'), {
      private_key: privateKey,
      preserve_key: true,
    }).then(res => {
      if (!res.ok) {
        let message = res.error || 'Failed to retrieve session key.';
        if (res.exception) {
          message = `${message}\n${res.exception}`;
        }
        showToast('danger', 'Failed to Retrieve Session Key', message);
        return;
      }

      if (res.data && res.data.session_key) {
        storeSessionKey(res.data.session_key);
        setSessionKeyInputs();
      }

      const privateKeyModal = getPrivateKeyModal();
      if (privateKeyModal) {
        privateKeyModal.hide();
      }

      if (pendingSessionKeyForm && hasSessionKey()) {
        const form = pendingSessionKeyForm;
        pendingSessionKeyForm = null;
        setSessionKeyInputs();
        form.dataset.sessionKeyBypass = 'true';
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
        return;
      }

      const userKeysPath = withBasePath('/plugins/secrets/user-keys/');
      if (window.location.pathname.startsWith(userKeysPath)) {
        showToast('success', 'Session Key Received', 'Refreshing to show the active session key...');
        window.setTimeout(() => {
          window.location.reload();
        }, 1200);
        return;
      }
      showToast('success', 'Session Key Received', 'You may now unlock secrets.');
    });
  }

  function initGetSessionKey() {
    const button = document.getElementById('request_session_key');
    if (!button) {
      return;
    }
    button.addEventListener('click', () => {
      const input = document.getElementById('user_privkey');
      if (input && 'value' in input) {
        requestSessionKey(input.value);
        input.value = '';
      }
    });
  }

  function initDeleteSessionKey() {
    for (const element of document.querySelectorAll('.delete-session-key')) {
      element.addEventListener('click', event => {
        event.preventDefault();
        apiDelete(withBasePath('/api/plugins/secrets/session-key/')).then(res => {
          if (!res.ok) {
            let message = res.error || 'Failed to delete session key.';
            if (res.exception) {
              message = `${message}\n${res.exception}`;
            }
            showToast('danger', 'Failed to Delete Session Key', message);
            return;
          }
          clearSessionKey();
          window.location.reload();
        });
      });
    }
  }

  function initSecretsEdit() {
    function handleSubmit(event) {
      setSessionKeyInputs();
      const form = event.target instanceof HTMLFormElement ? event.target : null;
      const privateKeyModal = getPrivateKeyModal();
      if (!form || !privateKeyModal) {
        return;
      }
      if (form.dataset.sessionKeyBypass === 'true') {
        form.dataset.sessionKeyBypass = '';
        return;
      }
      event.preventDefault();
      apiGet(withBasePath('/api/plugins/secrets/session-key/'))
        .then(res => {
          if (res.ok) {
            form.dataset.sessionKeyBypass = 'true';
            if (typeof form.requestSubmit === 'function') {
              form.requestSubmit();
            } else {
              form.submit();
            }
            return;
          }
          pendingSessionKeyForm = form;
          privateKeyModal.show();
        })
        .catch(() => {
          pendingSessionKeyForm = form;
          privateKeyModal.show();
        });
    }

    for (const element of document.querySelectorAll('.requires-session-key')) {
      const form = element.closest('form');
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
    }
  }

  function initSecrets() {
    setSessionKeyInputs();
    for (const func of [
      initGenerateKeyPair,
      initLockUnlock,
      initGetSessionKey,
      initDeleteSessionKey,
      initSecretsEdit,
    ]) {
      func();
    }
  }

  if (document.readyState !== 'loading') {
    initSecrets();
  } else {
    document.addEventListener('DOMContentLoaded', initSecrets);
  }
})();
</script>
